# Reusable workflow to render the spec for PRs.
# https://docs.github.com/en/actions/using-workflows/reusing-workflows

name: Render

on:
  workflow_call:
    inputs:
      container:
        required: false
        type: string
        default: ghcr.io/trustedcomputinggroup/pandoc
      container-version:
        required: true
        type: string
      input:
        required: true
        type: string

jobs:
  render:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.container }}:${{ inputs.container-version }}
    name: Render
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Cache LaTeX files
        uses: actions/cache@v3
        env:
          cache-name: cache-latex-${{ inputs.input }}-files
        with:
          path: |
            *.aux
            *.fdb_latexmk
            *.lof
            *.lot
            *.toc
            *.upa
            *.upb
            media/*.convert.pdf
          key: latex-${{ inputs.input }}-${{ github.run_id }}
          restore-keys: latex-${{ inputs.input }}

      - name: Render
        uses: ./.github/actions/render
        with:
          input: ${{ inputs.input }}
          output-basename: ${{ inputs.input }}
          pdf: true
          diffbase: "${{ github.event.pull_request.base.sha }}"
          pr-number: "${{ github.event.number }}"
          pr-repo: "${{ github.repository }}"

      - name: Upload pdfs
        uses: actions/upload-artifact@master
        with:
          name: ${{ inputs.output-pdf }}
          path: |
            *.pdf
        if: always()

      - name: Upload logs
        uses: actions/upload-artifact@master
        with:
          name: ${{ inputs.output-pdf }}
          path: |
            *.log
        if: always()
